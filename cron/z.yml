tasks:
    cron.build:
        args:
            target_env: ?
        set:
            build_file: sprintf("crontab.%s.txt", target_env)
        do:
            - echo "APPLICATION_ENV=$(target_env)" > ./$(build_file)
            - echo "ROOT=$$(ssh $(envs[target_env].ssh) "cd $(envs[target_env].root) && pwd")" >> ./$(build_file)
            - cat etc/crontab.txt >> ./$(build_file)
            - @(if VERBOSE) echo "Generated crontab for $(target_env)"; cat $(build_file)
        yield: build_file

    cron.install:
        args:
            target_env: ?
        pre:
            - @cron.diff
        unless: !confirm("install crontab?")
        do:
            - cat crontab.$(target_env).txt | ssh $(envs[target_env].ssh) "crontab -"

    cron.diff:
        args:
            target_env: ?
        do:
            - ssh $(envs[target_env].ssh) "crontab -l" | diff - $(tasks.cron.build) && echo "No differences in content" || true
